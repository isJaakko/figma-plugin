<h2>Rectangle Creator</h2>
<p>Count: <input id="count" value="5" /></p>
<button id="create">Create</button>
<button id="cancel">Cancel</button>
<script>
  function listen(eventType, cb) {
    // 收到消息后调用 cb 处理
    window.onmessage = ({ data: { pluginMessage: event } }) => {
      if (event.type === eventType) {
        const result = cb(event.data);
        const callbackData = {
          type: `${eventType}-callback`,
          data: result,
        };

        // 处理完成后将结果发送回去
        parent.postMessage({ pluginMessage: callbackData }, "*");
      }
    };
  }

  function post(event) {
    return new Promise((resolve, reject) => {
      // 触发事件
      parent.postMessage({ pluginMessage: event }, "*");
      // 监听事件回调处理结果
      window.onmessage = ({ data: { pluginMessage: cbEvent } }) => {
        if (cbEvent.type === `${event.type}-callback`) {
          resolve(cbEvent.data);
        }
      };
    });
  }

  /**
   * ui 向 plugin 发送事件
   */
  async function drawRectangle() {
    const textbox = document.getElementById("count");
    const count = parseInt(textbox.value, 10);
    const result = await post({ type: "create-rectangles", data: count });
  }

  function cancel() {
    post({ type: "cancel" });
  }

  document.getElementById("create").onclick = drawRectangle;
  document.getElementById("cancel").onclick = cancel;

  /**
   *  ui 监听 plugin 事件
   */
  listen("eventFromPlugin", (data) => {
    console.log("received from plugin:", data);
    return "good job";
  });
</script>
